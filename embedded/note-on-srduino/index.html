<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>电子积木开发手记（新篇） | The Bloom of Youth | 锦瑟华年</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="2012年10月13日很久没有写这个手记了，翻看了一下《电子积木开发手记》，发表的时间是3月24日。至今已经有六个半月了。半年多的时间里，这个项目已经发生了翻天覆地的变化。除了“电子积木”这个目标没有变以外，我们的硬件平台被推翻重做，再次推翻、再次重做，如此重复了很多次。但是值得欣慰的事情还是有的，首先就是获得了国家十万元的经费支持，这是我们开发初期重要的资金来源，感谢国家！我们的第一版UxBoa">
<meta property="og:type" content="article">
<meta property="og:title" content="电子积木开发手记（新篇）">
<meta property="og:url" content="http://kuangqi.me/embedded/note-on-srduino/index.html">
<meta property="og:site_name" content="The Bloom of Youth | 锦瑟华年">
<meta property="og:description" content="2012年10月13日很久没有写这个手记了，翻看了一下《电子积木开发手记》，发表的时间是3月24日。至今已经有六个半月了。半年多的时间里，这个项目已经发生了翻天覆地的变化。除了“电子积木”这个目标没有变以外，我们的硬件平台被推翻重做，再次推翻、再次重做，如此重复了很多次。但是值得欣慰的事情还是有的，首先就是获得了国家十万元的经费支持，这是我们开发初期重要的资金来源，感谢国家！我们的第一版UxBoa">
<meta property="og:image" content="http://kuangqi.me/images/cc.png">
<meta property="og:updated_time" content="2016-11-29T15:02:00.184Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="电子积木开发手记（新篇）">
<meta name="twitter:description" content="2012年10月13日很久没有写这个手记了，翻看了一下《电子积木开发手记》，发表的时间是3月24日。至今已经有六个半月了。半年多的时间里，这个项目已经发生了翻天覆地的变化。除了“电子积木”这个目标没有变以外，我们的硬件平台被推翻重做，再次推翻、再次重做，如此重复了很多次。但是值得欣慰的事情还是有的，首先就是获得了国家十万元的经费支持，这是我们开发初期重要的资金来源，感谢国家！我们的第一版UxBoa">
<meta name="twitter:image" content="http://kuangqi.me/images/cc.png">
<meta name="twitter:creator" content="@kuangqi">
  
    <link rel="alternative" href="/atom.xml" title="The Bloom of Youth | 锦瑟华年" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <link rel="stylesheet" href="/css/style.css">
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49728497-1', 'kuangqi.me');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


  
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fdcfa4b01ced33f05267029a75257dabb' type='text/javascript'%3E%3C/script%3E"));
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">The Bloom of Youth | 锦瑟华年</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">那些刻骨铭心的日子原本就云淡风轻</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">存档</a>
        
          <a class="main-nav-link" href="/works">作品集</a>
        
          <a class="main-nav-link" href="/about">关于我</a>
        
          <a class="main-nav-link" href="/arduino">《Arduino魔法书》专题页面</a>
        
          <a class="main-nav-link" href="https://coding.net/u/kqkq/p/blog/git">本博客源代码</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/kqkq" target="_blank" title="GitHub"></a>
        
        
          <a id="nav-weibo-link" class="nav-icon" href="http://weibo.com/kqwd" target="_blank" title="Sina Weibo"></a>
        
        
          <a id="nav-renren-link" class="nav-icon" href="http://www.renren.com/240043689" target="_blank" title="RenRen"></a>
        
        
          <a id="nav-twitter-link" class="nav-icon" href="https://twitter.com/kuangqi" target="_blank" title="Twitter"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kuangqi.me"></form>
      </div>
    </div>
  </div>
  <script>
    
    var d = new Date();
    var m = d.getMinutes();
    var num = Math.ceil((m + 1) / (60 / 6));
    document.getElementById("banner").style.backgroundImage = "url(/css/images/banner" + num + ".jpg)";
    
</script>
</header>
      <div class="outer">
        <section id="main"><article id="post-note-on-srduino" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/embedded/note-on-srduino/" class="article-date">
  <time datetime="2013-04-22T16:36:41.000Z" itemprop="datePublished">2013年04月23日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/embedded/">软硬兼施</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      电子积木开发手记（新篇）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      

        <!-- Table of Contents -->
        
            <div id="toc" class="toc-article">
              <strong class="toc-title">文章目录</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#2012年10月13日"><span class="toc-number">1.</span> <span class="toc-text">2012年10月13日</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PCB设计和制作"><span class="toc-number">1.1.</span> <span class="toc-text">PCB设计和制作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#焊接"><span class="toc-number">1.2.</span> <span class="toc-text">焊接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EEPROM"><span class="toc-number">1.3.</span> <span class="toc-text">EEPROM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译STM32的驱动库"><span class="toc-number">1.4.</span> <span class="toc-text">编译STM32的驱动库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#硬件设计缺陷"><span class="toc-number">1.5.</span> <span class="toc-text">硬件设计缺陷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-number">1.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2012年11月3日（Srduino-A3勘误）"><span class="toc-number">2.</span> <span class="toc-text">2012年11月3日（Srduino A3勘误）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2013年2月25日"><span class="toc-number">3.</span> <span class="toc-text">2013年2月25日</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码尺寸问题"><span class="toc-number">3.1.</span> <span class="toc-text">代码尺寸问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EEPROM驱动"><span class="toc-number">3.2.</span> <span class="toc-text">EEPROM驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#USB虚拟串口移植"><span class="toc-number">3.3.</span> <span class="toc-text">USB虚拟串口移植</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bootloader"><span class="toc-number">3.4.</span> <span class="toc-text">Bootloader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2013年4月12日"><span class="toc-number">4.</span> <span class="toc-text">2013年4月12日</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#固件部分"><span class="toc-number">4.1.</span> <span class="toc-text">固件部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#软件部分"><span class="toc-number">4.2.</span> <span class="toc-text">软件部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#硬件部分"><span class="toc-number">4.3.</span> <span class="toc-text">硬件部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2013年4月23日"><span class="toc-number">5.</span> <span class="toc-text">2013年4月23日</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Srduino-B1板子"><span class="toc-number">5.1.</span> <span class="toc-text">Srduino B1板子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Srduino-Mini板子"><span class="toc-number">5.2.</span> <span class="toc-text">Srduino Mini板子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Digital-Audio板子"><span class="toc-number">5.3.</span> <span class="toc-text">Digital Audio板子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4GHz-RF板子"><span class="toc-number">5.4.</span> <span class="toc-text">2.4GHz RF板子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JLink-ARM-OB板子"><span class="toc-number">5.5.</span> <span class="toc-text">JLink ARM OB板子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JTAG转接板子"><span class="toc-number">5.6.</span> <span class="toc-text">JTAG转接板子</span></a></li></ol></li></ol>
            </div>
        

        <h2 id="2012年10月13日"><a href="#2012年10月13日" class="headerlink" title="2012年10月13日"></a>2012年10月13日</h2><p>很久没有写这个手记了，翻看了一下<a href="/embedded/note-on-electronic-bricks/">《电子积木开发手记》</a>，发表的时间是3月24日。至今已经有六个半月了。半年多的时间里，这个项目已经发生了翻天覆地的变化。除了“电子积木”这个目标没有变以外，我们的硬件平台被推翻重做，再次推翻、再次重做，如此重复了很多次。但是值得欣慰的事情还是有的，首先就是获得了国家十万元的经费支持，这是我们开发初期重要的资金来源，感谢国家！我们的第一版UxBoard主板是一份非常优秀的课程作业，让我们在《嵌入式系统》课程中都获得了95分以上的高分，但有点小遗憾的是这个硬件平台面临被推翻的危险，但它毕竟是我们的第一块PCB，还是值得纪念。我们受邀参加大学生创新创业展览会，这将是推广我们的产品和理念的第一步，是一个很好的机会。当然还有最重要的，那就是我们一直都在努力，在遇到困难时也没有想放弃，整个项目现在在有着良好的发展势头。</p>
<p>感慨了这么多，这毕竟是个技术笔记，还是来说说最近做的PCB</p>
<a id="more"></a>
<h3 id="PCB设计和制作"><a href="#PCB设计和制作" class="headerlink" title="PCB设计和制作"></a>PCB设计和制作</h3><p>这块PCB可谓屡经波折。。。组员不靠谱，鼓捣了半个月，最后啥都没做出来，人退出项目组了。。。好吧~都让你做了我还不放心呢~我自己做还不成吗？自学了Allegro，发现其实是会了不难难了不会。。。元件封装确实比较麻烦，好在有神器“LP Wizard”。不过设计PCB还是件很耗时的事情，最终送工厂打样的PCB文件的编辑时间超过了40个小时。学习软件的各种波折就不记录了，反正现在都会用了。只记得于博士的SPB教程中对钻孔文件的输出讲的不是很详细，或者我没看着，反正是我又去专门搜索的钻孔文件的输出方法。<br>做PCB最大的两点就是跟工厂斗智斗勇了。为了充分利用10*10的空间，我在这块空间里拼了4块板子。地球人都知道，拼板要加钱，而且还加的不少。。。我开始的如意算盘不出所料被工厂一眼识破，直接说要加钱。那能行吗！于是又改了一下边框，工厂立马表示不用加钱了。。。我只是把槽开的短了一些。。。工厂真是自欺欺人。。。<br>于是最终花100元做了4块拼板的10块板子~还要了很骚气的白油黑字，但做出来没有想象的好看。。。丝印有断线和黑子貌似不如白字牢固，弄上酒精一刮就掉了。。。</p>
<h3 id="焊接"><a href="#焊接" class="headerlink" title="焊接"></a>焊接</h3><p>最难焊的估计就是那个QFN28封装的CP2102了。。。最后还是采用的烙铁烤板子的方法。第一块板子居然被烤糊了，完全低估了烙铁的温度。。。STM32的MCU焊接还算顺利，至少目前没发现大问题。FT2232就命途多舛了。。。焊的第一块仿真器板子，电脑居然不认。我就估计是芯片焊接的问题，于是又重新加热管脚，还是不认。。。最后都要抓狂了，怀疑不是焊接的问题了。。。最后把芯片拆下来，残余焊锡清理干净，用手用力按压到板子上，一上电，认了。。。看来还是焊接的问题。。。我作为一个成功焊接过LQFP100的选手，居然囧在这个LQFP48上，实在是很无奈。。。</p>
<h3 id="EEPROM"><a href="#EEPROM" class="headerlink" title="EEPROM"></a>EEPROM</h3><p>FT2232D要求的EEPROM貌似比较严格，有些型号虽然也符合16bit结构，但是就是不能用。我提前知道这种情况，在淘宝上买芯片时也注意了区分。但是不怕就怕啊！SB的买家居然发错了货！我要的AT93C46D，给我发了个AT93C46A。。。其实理论上说，AT93C46A应该也是可以用的（AT93C46A固定为16bit组织，而AT93C46D可以选择8bit还是16bit，ORG脚悬空即为16bit，跟A一样，但是A就是不能用。。。），但实际不行，FT2232根本就没法跟它通信，一个字节都读不出来，一直是Blank Device。后来死马当活马医，把打算放到主板上的M93C86按上去试了试，发现居然读出了东西。虽然工作还是异常，但至少有东西了。。。于是紧急奔到中发，买了10片ST的M93C46. 回来一试，果然好了！</p>
<h3 id="编译STM32的驱动库"><a href="#编译STM32的驱动库" class="headerlink" title="编译STM32的驱动库"></a>编译STM32的驱动库</h3><p>编译居然出错了。。。真是太神奇了。。。看了一下错误，大概是因为工程目录下CMSIS库extern了系统库里定义的东西，但是extern的类型跟系统库里定义的类型不太一样。。。ST官方给出的解决方法是，删掉驱动库自带的CMSIS（据网友说是1.3版本），通过修改工程设置来使用IAR自带的CMSIS（据说是2.1版本）。但网友指出，如果换了IDE还会出问题。所以建议直接用ARM官方的CMSIS最新版替换掉工程目录下的旧版本。这个看起来很有道理的样子，有空尝试一下~</p>
<h3 id="硬件设计缺陷"><a href="#硬件设计缺陷" class="headerlink" title="硬件设计缺陷"></a>硬件设计缺陷</h3><p>仿真器好了就开始跟主板联调，结果仿真器没法仿真STM32. 很无奈。最后实在没办法了，为了确定是仿真器的问题还是目标板的问题，就找出了当时做的UxBoard主板，那上面是TI的Cortex-M4的MCU，试了一下居然可以仿真！看电路图，发现我很SB的把STM的nTRST引脚放到了JTAG的5脚上，而这个脚对应在仿真器那边是GND。。。于是结果就是JTAG的寄存器一直处于复位状态，但是由于nSRST的位置的对的，所以目标板的复位目测是正常的。。。其实10pin的JTAG接口不应该包含nTRST引脚，但是STM32有这么个引脚，总不能不引出吧~下次打算放到7号，7号在仿真器那边是不连接的。</p>
<p>还有件很囧的事情，就是L那个指示灯一直是亮着的！！！去网上找来Arduino Uno第一版的电路图，发现这个LED是直接连接，没有运放隔离。而Uno第三版就加上了运放隔离。但是MCU复位后引脚默认应该是高阻输入的，那个灯确实应该一直亮着，而且还会因手指的触摸而改变亮度。。。实在是太囧了，目测Uno第三版也会有这个问题，有机会找个板子试试。这样的设计实在有点不靠谱，不如把LED设计成低电平点亮的。。</p>
<p>当然目前为止真正称得上是错误的应该就算自动复位的设计了，我的设计貌似没有像想象中的那样工作，可能需要通过修改原理图来更正，不知道PCB上能否小改一下。。。<br>2012年10月13日，更新啦！今天早上起来就在分析自动复位这个问题。研究后决定把复位脚上接地的104电容拆掉（标号C4），拆掉后自动复位果然工作正常了！</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>拼的4块板子，其中有个万能转接板，那个不算，剩下的3块都是有电路的。</p>
<ol>
<li>Srduino主板做成功的测试有：<ul>
<li>CP2102串口回显</li>
<li>修改CP2102的字符串</li>
<li>STM32通过CP2102串口ISP</li>
<li>STM32通过J-Link和Stellaris ICDI下载程序（闪烁LED）</li>
<li>通过拆除电容C4，自动复位已经正常工作了<br>失败的测试：</li>
<li><em>通过CP2102自动为STM32复位。。。但CP2102的DTR和RTS电平能正常拉低。</em></li>
</ul>
</li>
<li>Stellaris ICDI成功的测试：<ul>
<li>通过OpenOCD的GDB Server驱动仿真STM32、LM4F232（仅支持JTAG）</li>
<li>通过IAR内置的Stellaris ICDI驱动仿真LM4F232（JTAG和SWD均可）<br>失败的测试：</li>
<li>用IAR内置的Stellaris ICDI驱动仿真STM32。</li>
<li>还有一个问题就是红色的DEBUG灯不会熄灭。。。</li>
</ul>
</li>
<li>STM8S最小系统：只测试了用SWID下载了一个闪烁LED的程序，成功了。</li>
</ol>
<hr>
<h2 id="2012年11月3日（Srduino-A3勘误）"><a href="#2012年11月3日（Srduino-A3勘误）" class="headerlink" title="2012年11月3日（Srduino A3勘误）"></a>2012年11月3日（Srduino A3勘误）</h2><p>Srduino A3 PCB调试过程中发现以下设计缺陷，将会在未来版本中更正</p>
<ol>
<li><p>自动复位电容C4原设计为100nF，实际应用中无法自动复位。此电容的正确容值应为10nF</p>
</li>
<li><p>IO板10pin JTAG排针5号脚，原设计为nTRST，而仿真板5脚为GND。直接使用排线连接两个排针会导致IO板一直处于复位状态。应将IO板的nTRST不引出，或者引出到未使用的7号脚位置。</p>
</li>
<li><p>IO板USB DEVICE接口的D+信号线未上拉，直接连接了MCU，会导致USB设备无法枚举。<del>此处应将D+信号线使用1.5k电阻上拉至3.3V。视实际应用，可能还需要添加三极管控制是否上拉，以便在合适的时候通知上位机重新枚举USB设备。</del></p>
<p> 编程过程需要对设备进行重枚举（USB Composite Device理论上可以实现CDC+DFU，但据Maple主页上的描述来看，这么做在Windows下会有问题。若无法实现CDC+DFU的Composite Device，则必须进行重枚举。此说法待验证。）官方Evaluation Board的做法是使用单片机的一个IO口和两个三极管控制1.5K电阻是否连接D+，但我们认为有更简单的方法。目前我们的做法是<strong>将1.5K电阻一段接D+，另一端接一空闲IO口。IO口推挽输出高电平即为USB接通，IO口开漏输出高电平（实为悬空）即为USB断开。从而完成USB重枚举。此方法目前工作正常。</strong></p>
</li>
<li><p>仿真板丝印错误，FT2232右上方丝印中，两列四行的表格中，第一列第三行原为RX，应为TX；第一列第四行原为TX，应为RX。</p>
</li>
<li><p>指示灯L，原设计为高电平点亮，但在芯片高阻态时，此指示灯会常亮，且可能因手指触碰运放引脚而改变其亮度。当相应引脚作为输出状态时，则工作正常。拟在下一个版本中将其改为低电平点亮。或许可以通过修改连接运放的极性来更正？</p>
</li>
<li><p>丝印层PLATFORM写成了PLANTFORM，PERFORMANCE写成了PROFORMANCE…….丢人都不知道丢到哪里去了。。。</p>
</li>
<li><p>下一版本考虑将IOREF旁边未连接的针脚用于连接Vbat，用于给RTC提供后备电源。</p>
</li>
<li><p>再次发现一处丝印层错误！！！Srduino板JTAG口TDO和TCK两个的位置标反了。。。</p>
</li>
<li><p>EEPROM型号确定为ST的M93C86</p>
</li>
<li><p>供电电路和电磁兼容性优化</p>
<ul>
<li>3.3V稳压器换小封装（SOT89或者SOT23-5）</li>
<li>增加电解电容滤波</li>
<li>根据实验结果将LM324更换为LM358或者LMV358，串口指示灯不用隔离，恢复直连</li>
<li>根据实验结果确定是否要对VDDA和VSSA设置独立的LDO稳压器</li>
<li>根据实验结果确定是否将模拟地VSSA直接连到GND</li>
<li>根据实验结果确定是否更换MOSFET的型号</li>
<li>修改USB口保护方案</li>
<li>修改运放电压比较器分压为1:1</li>
</ul>
</li>
<li><p>将BOOT0和RTS两个测试孔拉近</p>
</li>
</ol>
<hr>
<h2 id="2013年2月25日"><a href="#2013年2月25日" class="headerlink" title="2013年2月25日"></a>2013年2月25日</h2><p>我要先吐个槽！！！我真的觉得我够到了我的智商上限。。。我已经很努力的思考一些问题了，但是一定要经过足够长的时间，我才能找到正确的思路</p>
<h3 id="代码尺寸问题"><a href="#代码尺寸问题" class="headerlink" title="代码尺寸问题"></a>代码尺寸问题</h3><p>这个问题不再详谈了，已经写了一篇两三千字的文章了。那段时间实在是郁闷。。。动不动代码尺寸就爆了。。。Hello world就要90KB。。。完全不知道如何下手。。。一天晚上跟MM聊天，突然迸发出一个灵感，逆向思维。删代码，直到删到代码尺寸降下来为止。这个思路很有效，后来发现那次代码尺寸暴增是由纯虚函数导致的。导致代码膨胀的原因还有很多，我基本都碰上了，详情去看<a href="/embedded/reduce-the-code-size-in-embedded-cpp/">《如何在嵌入式C++开发中缩减代码尺寸》</a>这篇文章吧~完全是一部血泪史。。。</p>
<h3 id="EEPROM驱动"><a href="#EEPROM驱动" class="headerlink" title="EEPROM驱动"></a>EEPROM驱动</h3><p>一个调了一天的问题。。。结果是因为时钟线的频率太高了，超过了EEPROM芯片的最高速度。。。随手加了个循环浪费时间，频率降下来了，驱动就通了。很庆幸我能按照Datasheet一次性的时序逻辑写对，否则调试起来就真蛋疼了。。。</p>
<h3 id="USB虚拟串口移植"><a href="#USB虚拟串口移植" class="headerlink" title="USB虚拟串口移植"></a>USB虚拟串口移植</h3><p>又是一部血泪史。没得说，就是看官方的example代码。开始想偷懒，打算把程序拿过来随便改改整合进去，完全行不通，官方的文档又很学术，没啥具体的东西。只能看代码。。。有几个细节记录一下，首先就是拙计的英语。。。有个词组叫correct transfer，我以为这是一种特殊的传输，就像Control transfer、Bulk transfer等等这些词组，都是USB标准里规定的一种传输方式，有特定的工作模式。可是我翻遍了USB标注也没找到到底什么叫correct transfer。。。我那个郁闷啊。。。由于对correct transfer的理解错误，还导致了很多bug。。。终于，有一天，我意识到我SB了。。。correct transfer就是字面意思，就是正确传输。。。就说这次传输数据没发生错误，对方也收到了，这就叫正确传输了，correct transfer。。。。。。。。。。。。。。。。。。。。。。。。。。。。。</p>
<p>再有就是一个芯片或者USB库的一个bug了（不知道算不算bug。。。），就是<code>EPx_OUT_Callback</code>会收到长度为0的包。。。如果这时你闭着眼把Endpoint置为NAK状态，你就别想回来了。。。因为处理数据的函数无事可做，就不会重新将Endpoint置为<code>ACK</code>，当然又不会有新的数据发来，于是就歇菜了。。。解决方法，只能自己判断一下，长度是0的话就不要置为<code>NAK</code>。。。哦，好像系统会自动给你置为<code>NAK</code>，你必须手动置为<code>VALID</code>才行！！！我真的很幸运，第一个思路就是怀疑是数据包的长度出了问题，否则按照程序员“一定是我哪里搞错了”的思路，我无论如何也不会想到把断点加到Endpoint的callback里。。。</p>
<h3 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h3><p>血泪史啊！！！！我觉得核心库做的差不多了，通过虚拟串口复位也加上了，打算加上bootloader，走一下流程了。结果，傻逼了！！！</p>
<p>首先是Maple的bootloader太2B了，编译居然不能开优化！！！一个-O1的优化就会导致其不能运行。。。估计是哪儿该加volatile的地方没加，被优化坏了。。。决定先不管bootloader，先用着O0，改天有空再研究优化的问题。</p>
<p>接着就是最2B的事件了。。。加上bootloader之后，程序居然不能运行了！！！没有bootloader的时候好好的啊~连接脚本已经把起始地址改成相应的bootloader跳转的地址了，后来发现是中断向量表的位置没有在代码中设置。。。但设置了之后，程序还是不对劲。程序就是最简单的闪烁LED，但是LED闪烁64次后程序就会挂掉。。。我至今都非常不明白我是怎么发现是64次的。。。总之我神奇的发现了这个神气的现象，但我不能解释。。。</p>
<p>64是个比较特殊的数字，很多常量都设置成了64. 后来随手把串口rx队列长度改成了32，发现闪烁32次后停机。我就觉得闹鬼了，闪烁led是死循环，跟串口队列长度有毛线关系啊！终于，，，经过几个小时的思考和艰苦查找，我发现！！！闪烁的LED居然就是串口RX的指示灯！！！于是闪一下，串口就收到一个数据，数据就被放到队列里。。。然后64下之后，队列满了，程序就挂了。。。。。实在是太！二！了！！！！</p>
<hr>
<h2 id="2013年4月12日"><a href="#2013年4月12日" class="headerlink" title="2013年4月12日"></a>2013年4月12日</h2><h3 id="固件部分"><a href="#固件部分" class="headerlink" title="固件部分"></a>固件部分</h3><p>巧妙的分配单片机的定时器是非常有挑战性的。我们有望比Arduino做得更好！</p>
<h3 id="软件部分"><a href="#软件部分" class="headerlink" title="软件部分"></a>软件部分</h3><p>首次走通了全部的流程。已经可以在VIM中实现一键编译、复位并刷写了。<br>第一次手动编写了自己的Makefile，是不是很弱爆。。。</p>
<p>之前敲各种make敲到手软，但也只是知道Makefile这个东西而已。自己编写Makefile之前还试图用各种工具自动生成，结果越弄越乱。想到松哥之前说的一句话，不到10万行的项目根部不需要这种工具，遂放弃自动生成，改为手动编写。<br>Makefile大概有60行左右，包含了编译、连接、objdump和size以及reset和dfu-util调用等操作，用起来还是很方便的。</p>
<p>唯一要吐槽的地方是，我花了一天的时间写这个Makefile。。。我本以为中午就能搞定，结果在晚上9点终于调通了的时候，发现好像没吃晚饭。。。“马上就能做完”果然是程序员三大错觉之一！</p>
<h3 id="硬件部分"><a href="#硬件部分" class="headerlink" title="硬件部分"></a>硬件部分</h3><p>这个是最近的重头戏了吧。新版PCB的设计和打样，是我们开发进程中的重要一步。新版的PCB全面更换了阻容元件封装，优化了供电电路、还改动了USB接口、AD转换接口等位置，修复了在A3版中发现的所有bug。由于引脚映射发生了些许的变化，固件库也需要跟着升级一下。</p>
<p>另外为了最大限度利用PCB空间，我们还在这块板子中拼入了一个Srduino Mini，这是一个简化的Srduino，尺寸与51单片机类似。还拼入了一个数字音频扩展板，由飞利浦的经典I2S接口的DA芯片TDA1543进行音频解码，板上还包含了一个microSD卡槽。另外拼入了一个基于nRF24L01+的2.4G射频模块，参考了官方的设计，将0402封装的元件更换为了0603. 最后一个拼版是J-Link OB仿真器，之前仿制的开源仿真器实在是不能令人满意，在IDE兼容性、跨平台特性等诸多方面都存在问题。这次索性使用了山寨J-link。之前已经在一块废板上进行了测试，J-Link OB工作非常稳定。</p>
<p>这次PCB设计总结了之前版本的经验，吸取了教训。在丝印层方面，放弃了教学视频中提及的Autosilk，因为这个层经常因元件调整带来各种问题，使得刚刚修改好非常美观的布局变得面目全非。看名字也知道，这个层是由系统自动管理的。这次我们配合使用了Board Geometry中的Silkscreen、Package Geometry中的Silkscreen和Components中的RefDes的Silkscreen。分别用于管理板级的图案（例如Logo和说明文字）、元件本身的丝印图案（例如正负极标志）和元件的索引编号。实验证明，即使在调整好丝印之后再次改动布局和布线，也只有在改动中旋转了方向的器件的丝印需要手动转一下，其它内容几乎不需要再重新调整。这才应该是调整丝印的正常状态！之前版本之所以丝印出现那么多bug，就跟管理丝印的方法有关！</p>
<p>本版还常识使用Illustrator制作矢量图，直接导入Allegro作为Logo，但是最终没有成功。不过由矢量图直接输出指定尺寸的BMP图像还是很方便的。另外我们还发现了上一版的Logo存在一些较细的笔画印不出来的问题，这次也同时对图像的内容和BMP to IPF的参数进行了调整，有望彻底解决这个问题。</p>
<p>新版PCB已经箭在弦上，希望在接下来的封装验证、PCB打样和焊接调试中进展顺利！</p>
<hr>
<h2 id="2013年4月23日"><a href="#2013年4月23日" class="headerlink" title="2013年4月23日"></a>2013年4月23日</h2><p>这次PCB打样太给力了！下单后48小时就发货了，快递也给力，隔天就从深圳寄到北京了！</p>
<p>史无前例的6块板子拼板！省钱省到家了！不过事实也证明了，投入多少精力就会有多少回报。在Srduino B1版上，可是说我精雕细琢。因为之前有积累，这次也一举修复了之前在A3版上发现的所有硬件bug。目前为止Srduino B1没有发现啥明显的bug，希望不要再有bug了！</p>
<p>其他的拼板，因为画的时候就抱着试一试，允许失败的态度，所以自然就出现了一些比较无语的错误。。。下面将发现的所有的错误总结如下</p>
<h3 id="Srduino-B1板子"><a href="#Srduino-B1板子" class="headerlink" title="Srduino B1板子"></a>Srduino B1板子</h3><ol>
<li>microUSB钻孔直径过大，应为0.65mm，实际上有41mil，超过1.00mm</li>
<li>光学识别点中心没有铜</li>
<li>Top层丝印的Logo仍与想象的有一定出入，不过至少所有笔画都能看清了！不知道是否跟厂家印刷的精度有关。</li>
<li>下一版要把注册商标的标志(TM)和官方网站的链接加上去！还可以考虑弄个二维码~</li>
</ol>
<h3 id="Srduino-Mini板子"><a href="#Srduino-Mini板子" class="headerlink" title="Srduino Mini板子"></a>Srduino Mini板子</h3><ol>
<li>丝印Logo完全看不清楚</li>
</ol>
<h3 id="Digital-Audio板子"><a href="#Digital-Audio板子" class="headerlink" title="Digital Audio板子"></a>Digital Audio板子</h3><ol>
<li>3.5mm耳机插孔封装的封装错误：<ul>
<li>5个非电气孔没有打出来！</li>
<li>摆放边界没有预留合理的空间，隔着旁边的运放芯片太近！差点就插不上了</li>
<li>圆形的电气孔直径太小，费好大劲才能把插座插进去</li>
</ul>
</li>
<li>microSD卡槽封装的问题<ul>
<li>非电气孔直径过大！</li>
<li>若非电气孔直径合适，那电气焊盘预留的长度是否足够？</li>
</ul>
</li>
<li>低级错误：2*8pin的SPI&amp;I2S插口摆放的位置不对，无法与基板重合，相差了100mil，基本导致该PCB报废，只能用杜邦线连接</li>
</ol>
<h3 id="2-4GHz-RF板子"><a href="#2-4GHz-RF板子" class="headerlink" title="2.4GHz RF板子"></a>2.4GHz RF板子</h3><ol>
<li>通信不稳定，不确定是由于元件导致、程序导致还是PCB导致的。</li>
<li>16MHz直插晶振封装的摆放边界没有预留出合理的空间，几乎导致其金属外壳与旁边的焊盘短路，只好给它垫上一层胶带</li>
</ol>
<h3 id="JLink-ARM-OB板子"><a href="#JLink-ARM-OB板子" class="headerlink" title="JLink ARM OB板子"></a>JLink ARM OB板子</h3><ol>
<li>JTAG接口的方向错误，无法直接插到Srduino B1上，只能用一条排线连过去。不过貌似无伤大雅。下一版可以考虑去掉按键，而使用全尺寸的2*5牛角座</li>
<li>同样是晶振的问题，金属外壳几乎要与旁边的电容短路。</li>
</ol>
<h3 id="JTAG转接板子"><a href="#JTAG转接板子" class="headerlink" title="JTAG转接板子"></a>JTAG转接板子</h3><p>这个应该不会有bug吧。。。</p>
<hr>
<p><strong>版权声明</strong></p>
<p><img src="/images/cc.png" alt=""></p>
<p><a href="http://kuangqi.me">The Bloom of Youth</a> by <a href="http://kuangqi.me/about">KUANG Qi</a> is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external">Creative Commons BY-NC-ND 4.0 International License</a>.<br>由<a href="http://kuangqi.me/about">况琪</a>创作并维护的<a href="http://kuangqi.me">锦瑟华年</a>博客采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external">创作共用保留署名-非商业-禁止演绎4.0国际许可证</a>。</p>
<p>本文首发于<a href="http://kuangqi.me">The Bloom of Youth | 锦瑟华年</a>博客（ <a href="http://kuangqi.me">http://kuangqi.me</a> ），版权所有，侵权必究。</p>
<p>本文永久链接：<a href="http://kuangqi.me/embedded/note-on-srduino/">http://kuangqi.me/embedded/note-on-srduino/</a></p>

      
    </div>
    <footer class="article-footer">
      
        
<div class="bdsharebuttonbox"><a href="#" class="_bds_more" data-cmd="more">分享本文</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_mail" data-cmd="mail" title="分享到邮件分享"></a><a href="#" class="bds_print" data-cmd="print" title="分享到打印"></a><a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a><a class="bds_count" data-cmd="count"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/embedded/note-on-stm32-rtc-oscillator/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          STM32 RTC晶振起振指南
        
      </div>
    </a>
  
  
    <a href="/embedded/reduce-the-code-size-in-embedded-cpp/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">如何在嵌入式C++开发中缩减代码尺寸</div>
    </a>
  
</nav>

  
</article>




<section id="comments">
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"kqkq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tricks/">工巧匠心</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/essay/">我笔我心</a><span class="category-list-count">30</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ios/">果粉手札</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/image-processing/">绘云描鲤</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">编程之美</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/embedded/">软硬兼施</a><span class="category-list-count">13</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/embedded/in-depth-analysis-on-arduino-eslov/">Arduino ESLOV深度解析</a>
          </li>
        
          <li>
            <a href="/tricks/append-a-copyright-info-after-every-post/">为Hexo博客的每一篇文章自动追加版权信息</a>
          </li>
        
          <li>
            <a href="/programming/lcs-made-simple/">最长公共子序列（LCS）问题完全解析</a>
          </li>
        
          <li>
            <a href="/programming/leetcode-number-of-1-bits/">LeetCode 191 Number of 1 Bits 题解</a>
          </li>
        
          <li>
            <a href="/programming/leetcode-remove-element/">LeetCode 027 Remove Element 题解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Weibo show</h3>
    <div class="widget-weibo">
      <iframe width="100%" height="500" class="share_self" frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1839031723&verifier=2dad15cd&colors=dddddd,dddddd,4473924,0069a4,dddddd&dpc=1"></iframe>
    </div>
  </div>

  
    <div class="widget-wrap">
  <h3 class="widget-title">LINKS</h3>
  <div class="widget">
  <ul class="entry">
  <li><a href="http://kqwd.blog.163.com/" title="老博客">网易老博客</a>：一座终将失守的空城</li>
  <li><a href="http://blanboom.org/" title="Blanboom">Blanboom</a>：折腾不止，是为创客</li>
  </ul>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 况琪<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">存档</a>
  
    <a href="/works" class="mobile-nav-link">作品集</a>
  
    <a href="/about" class="mobile-nav-link">关于我</a>
  
    <a href="/arduino" class="mobile-nav-link">《Arduino魔法书》专题页面</a>
  
    <a href="https://coding.net/u/kqkq/p/blog/git" class="mobile-nav-link">本博客源代码</a>
  
</nav>
    

<script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
//<![CDATA[
if (typeof jQuery == 'undefined') {
  document.write(unescape("%3Cscript src='/js/jquery-2.0.3.min.js' type='text/javascript'%3E%3C/script%3E"));
}
// ]]>
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>